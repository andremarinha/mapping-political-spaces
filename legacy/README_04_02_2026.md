# Social Class in Southern Europe (ESS Rounds 1-11)

**Project: ch2_mapping**

## 1. Project Philosophy

-   **Structure**: Follows a strict separation of inputs, scripts, and outputs.
-   **Reproducibility**: Uses relative paths within the `ch2_mapping.Rproj` environment.
-   **Integrity**: `data/raw/` is read-only. Intermediate files live in `data/temp/`.
-   **Standardization**: All visualizations use a unified design language (Plasma palette, consistent NA handling).

## 2. Folder Structure

-   `data/`
    -   `raw/ESS/`: Contains `ess_integrated_rounds1_11.csv` (Original Input).
    -   `temp/`: Intermediate `.rds` files (01_raw, 02_weighted, 03_classed).
    -   `master/`: **`ess_final.rds`** (The single source of truth for analysis)
-   `scripts/`
    -   `R_scripts/`: The active production pipeline (01-05).
    -   `v1_archive/`: Deprecated scripts from previous attempts.
    -   `*.qmd`: Reference files for MCA/PCA interpretation logic (e.g., `Análise multivariada_A2_ACM_AC.qmd`).
-   `figures/`: High-resolution plots (PNG 300dpi + pdf)
-   `tables/`: Data audit tables and distribution summaries (.csv)
-   `log/`: Automated execution logs.
-   `writing/`: Future LaTeX manuscripts.
-   `presentation/`: Future Beamer slides.

## 3. Data Scope and Engineering Pipeline

-   **Target**: Adults 18+ in PT, ES, GR, IT.
-   **Rounds**: 1–11 (GR and IT have gaps).

The dataset is built via 5 sequential scripts in `scripts/R_scripts/`. **Must be run in order**:

+------------+---------------------+-------------------------------------------------------------------------------+---------------------------------+
| **Script** | **Action**          | **Logic / Critical details**                                                  | **Output**                      |
+------------+---------------------+-------------------------------------------------------------------------------+---------------------------------+
| **01**     | `01_load_data.R`    | Filters for **PT, ES, IT, GR**. Cleaning numeric/character types.             | `01_raw_data.rds`               |
+------------+---------------------+-------------------------------------------------------------------------------+---------------------------------+
| **02**     | `02_weighting.R`    | Calculates `analysis_weight`. Formula: `pspwght * pweight * 10000`.           | `02_weighted_data.rds`          |
+------------+---------------------+-------------------------------------------------------------------------------+---------------------------------+
| **03**     | `03_class_coding.R` | **Oesch 16/8:** Manual syntax (Ranges).                                       | `03_classed_data.rds`           |
|            |                     |                                                                               |                                 |
|            |                     | **ORDC/EGP:** `DIGCLASS` (ISCO-88 bridged).                                   |                                 |
|            |                     |                                                                               |                                 |
|            |                     | **Microclass:** `DIGCLASS` (Rounds 6-11 only).                                |                                 |
+------------+---------------------+-------------------------------------------------------------------------------+---------------------------------+
| **04**     | `04_final_merge.R`  | **Crucial Fix:** Explicitly maps unmapped ORDC codes to "14. Unclassifiable". | **`data/master/ess_final.rds`** |
|            |                     |                                                                               |                                 |
|            |                     | Final selection of variables.                                                 |                                 |
+------------+---------------------+-------------------------------------------------------------------------------+---------------------------------+
| **05**     | `05_descriptives.R` | Generates Audit Heatmaps and Distribution Plots.                              | `figures/*.png`                 |
|            |                     |                                                                               |                                 |
|            |                     | Applies **Plasma** palette standards.                                         |                                 |
+------------+---------------------+-------------------------------------------------------------------------------+---------------------------------+

## 4. Methodological Decisions

-   **A. Weighting Strategy**

    -   **Issue:** ESS changed the weighting variables in Round 9 (`anweight`)
    -   **Solution:** Hybrid strategy (R1-8: $dweight \times pweight$; R9-11: $anweight$).
        -   $Weight$ = $pspwght \times pweight \times 10000$ (see [ESS Weighting Guide V1.1](https://www.europeansocialsurvey.org/sites/default/files/2023-06/ESS_weighting_data_1_1.pdf)., p. 6)
            -   The 10k factor makes weighted counts readable integers

-   **Class Scheme Implementation**: ORDC (Primary), Oesch (Primary), EGP & Microclasses (Supplementary).

    -   Oesch (8-class): Implemented via strict manual ranges (Oesch's original syntax applied to R)
    -   **ORDC (13-class)**:
        -   **Core**: Derived using `DIGCLASS` package.

        -   **Gap Fix**: About 10-15% of respondents (e.g., Armed Forces, vague codes) are not covered by the standard 13 classes.

        -   **Decision**: These are **NOT** dropped. They are explicitly coded as **"14. Unclassifiable / Armed Forces"** (Grey in plots).

    <!-- -->

    -   **Microclass**: Only generated for **Rounds 6-11** (requires ISCO-08). Returns `NA` for Rounds 1-5.

-   **Visualization Standards:**

    -   **Palette**: `viridis::plasma` (Purple to Yellow) for all ordinal/nominal class schemes.

    <!-- -->

    -   **Missing/Other**: Explicit **Grey (`grey80`)** for "Unclassifiable" or non-applicable data.

    -   **Layout**: Heatmaps use a 2x2 grid. Bar charts use condensed bottom legends.

-   **MCA Strategy**: Will follow the reporting logic of `Análise multivariada_A2_ACM_AC.qmd`.

## 5. Decision Log

-   **[Decision 01]**: Input data converted to `.rds` immediately to preserve data types.

-   **[Decision 02]**: "Keep All Variables" approach used in Script 01 to prevent data loss.

-   **[Decision 03]**: **ORDC Gap**: Discovered \~15% missing in `05_descriptives`. Fixed in `04_final_merge` by forcing a 14th category instead of dropping them.

-   **[Decision 04]**: **Visuals**: Switched from "Darker = Higher" to "Lighter (Yellow) = Higher" coverage in heatmaps for better contrast.

## 6. Key Outputs

-   **Master File**: `data/master/ess_final.rds`

-   **Audit**: `figures/coverage_heatmap.png` (Visualizes the Microclass R1-5 gap).

-   **Results**: `figures/ordc_distribution.png` (Shows class structure evolution).
